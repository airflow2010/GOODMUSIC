<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>GOODMUSIC Admin</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #333; }
        th { background-color: #2a2a2a; }
        tr:hover { background-color: #2a2a2a; }
        .stat-card { background-color: #2a2a2a; padding: 15px; border-radius: 4px; margin-bottom: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="logo-wrap" style="margin-bottom: 0;">
            <img class="logo" src="{{ url_for('static', filename='prism_fullsize.png') }}" alt="Logo">
        </div>
        <select onchange="window.location.href=this.value" class="nav-select">
            <option value="{{ url_for('rating_mode') }}">rate</option>
            <option value="{{ url_for('playing_mode') }}">play</option>
            <option value="{{ url_for('admin_mode') }}" selected>admin</option>
        </select>
    </div>
    
    <h2>General Statistics</h2>
    <div class="stat-card">
        <div class="stat-row">
            <strong>Total Entries:</strong>
            <span>{{ stats.total_entries }}</span>
        </div>
        <div class="stat-row">
            <strong>Rated Entries:</strong>
            <span>{{ stats.rated_count }} ({{ stats.rated_pct }}%)</span>
        </div>
        <div class="stat-row">
            <strong>Favorites:</strong>
            <span>{{ stats.favorite_count }} ({{ stats.favorite_pct }}%)</span>
        </div>
        <div class="stat-row">
            <strong>Rejected:</strong>
            <span>{{ stats.rejected_count }} ({{ stats.rejected_pct }}%)</span>
        </div>
    </div>

    <h2>Genre Statistics</h2>
    <table>
        <thead>
            <tr>
                <th>Genre</th>
                <th>Count</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% for genre in stats.genre_stats %}
            <tr>
                <td>{{ genre.name }}</td>
                <td>{{ genre.count }}</td>
                <td>{{ genre.pct }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 style="margin-top: 40px;">Video Import</h2>
    <div class="stat-card">
        {% if import_restricted %}
        <h3>from Substack or YouTube playlists/IDs</h3>
        <div style="background-color: #3e3e3e; border-left: 5px solid #ffcc00; padding: 15px; margin-top: 10px;">
            <strong style="color: #ffcc00;">Functionality Restricted</strong>
            <p style="margin-top: 10px; margin-bottom: 0;">
                Importing videos is currently disabled because this instance is running in the cloud and no <code>cookies.txt</code> file was found. 
                YouTube blocks automated requests from cloud IP addresses.
            </p>
            <p style="margin-top: 10px; margin-bottom: 0;">
                To enable this feature, please run the application locally or deploy a valid <code>cookies.txt</code> file.
            </p>
        </div>
        {% else %}
        <h3>from Substack</h3>
        <form id="scraper-form" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center;">
                <label for="limit_posts" style="width: 280px; font-size: 0.9em;">--limit-substack-posts (0 for all)</label>
                <input type="text" id="limit_posts" name="limit_posts" value="0" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; width: 100px;">
            </div>
            <div style="display: flex; align-items: center;">
                <label for="limit_entries" style="width: 280px; font-size: 0.9em;">--limit-new-db-entries (0 for all)</label>
                <input type="text" id="limit_entries" name="limit_entries" value="10" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; width: 100px;">
            </div>
            <div style="display: flex; align-items: center;">
                 <label for="substack_url" style="width: 280px; font-size: 0.9em;">--substack</label>
                 <input type="text" id="substack_url" name="substack_url" value="https://goodmusic.substack.com/archive" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; width: 50%;">
            </div>
            <button type="submit" class="next-button" style="width: auto; margin-top: 10px; align-self: flex-end; background-color: mediumpurple;">Import</button>
        </form>
        
        <pre id="scraper-output" style="background-color: #111; color: #0f0; padding: 15px; border-radius: 4px; margin-top: 15px; height: 300px; overflow-y: auto; display: none; white-space: pre-wrap; font-family: monospace; font-size: 0.9em;"></pre>

        <h3 style="margin-top: 20px;">from YouTube playlist</h3>
        <form id="playlist-form" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center;">
                <label for="playlist_id" style="width: 280px; font-size: 0.9em;">Playlist ID (or full URL)</label>
                <input type="text" id="playlist_id" name="playlist_id" placeholder="PLxxxx" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; width: 50%;">
            </div>
            <div style="display: flex; align-items: center;">
                <label for="playlist_limit" style="width: 280px; font-size: 0.9em;">Limit (0 for all)</label>
                <input type="number" id="playlist_limit" name="playlist_limit" value="0" min="0" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; width: 100px;">
            </div>
            <button type="submit" class="next-button" style="width: auto; margin-top: 10px; align-self: flex-end; background-color: mediumpurple;">Import</button>
        </form>
        <pre id="playlist-output" style="background-color: #111; color: #0f0; padding: 15px; border-radius: 4px; margin-top: 15px; height: 220px; overflow-y: auto; display: none; white-space: pre-wrap; font-family: monospace; font-size: 0.9em;"></pre>

        <h3 style="margin-top: 20px;">from YouTube ID</h3>
        <form id="single-video-form" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="display: flex; align-items: center;">
                <label for="video_ids" style="width: 280px; font-size: 0.9em;">Video IDs (comma or newline separated)</label>
                <input type="text" id="video_ids" name="video_ids" placeholder="abc123, def456" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; width: 50%;">
            </div>
            <button type="submit" class="next-button" style="width: auto; margin-top: 10px; align-self: flex-end; background-color: mediumpurple;">Import</button>
        </form>
        <pre id="single-video-output" style="background-color: #111; color: #0f0; padding: 15px; border-radius: 4px; margin-top: 15px; height: 180px; overflow-y: auto; display: none; white-space: pre-wrap; font-family: monospace; font-size: 0.9em;"></pre>
        {% endif %}
    </div>

    <h2 style="margin-top: 40px;">Authentication</h2>
    <div class="stat-card">
        <div class="stat-row">
            <strong>Current Session:</strong>
            <span>{{ auth_status }}</span>
        </div>
        <div style="margin-top: 15px; text-align: right;">
            <a href="{{ url_for('logout') }}" class="button-link" style="background-color: #d32f2f; color: white;">Logout</a>
        </div>
    </div>

    <h2 style="margin-top: 40px;">Database</h2>
    <div class="stat-card">
        <p style="margin: 0; color: #aaa;">(Placeholder for future database management features)</p>
    </div>
</div>

<script>
    function streamToOutput(url, outputEl) {
        outputEl.style.display = 'block';
        outputEl.textContent = 'Initializing...\n';

        fetch(url)
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            outputEl.textContent += '\n--- End of Stream ---';
                            return;
                        }
                        const text = decoder.decode(value);
                        outputEl.textContent += text;
                        outputEl.scrollTop = outputEl.scrollHeight;
                        read();
                    });
                }
                read();
            })
            .catch(err => {
                outputEl.textContent += `\nError: ${err}`;
            });
    }

    document.getElementById('scraper-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const output = document.getElementById('scraper-output');
        const limitPosts = document.getElementById('limit_posts').value;
        const limitEntries = document.getElementById('limit_entries').value;
        const substackUrl = document.getElementById('substack_url').value;

        const url = new URL("{{ url_for('run_scraper') }}", window.location.origin);
        url.searchParams.append('limit_posts', limitPosts);
        url.searchParams.append('limit_entries', limitEntries);
        url.searchParams.append('substack_url', substackUrl);

        streamToOutput(url, output);
    });

    document.getElementById('playlist-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const output = document.getElementById('playlist-output');
        const playlistId = document.getElementById('playlist_id').value;
        const limit = document.getElementById('playlist_limit').value;

        const url = new URL("{{ url_for('import_playlist') }}", window.location.origin);
        url.searchParams.append('playlist_id', playlistId);
        url.searchParams.append('limit', limit);

        streamToOutput(url, output);
    });

    document.getElementById('single-video-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const output = document.getElementById('single-video-output');
        const videoIds = document.getElementById('video_ids').value;

        const url = new URL("{{ url_for('import_video') }}", window.location.origin);
        url.searchParams.append('video_ids', videoIds);

        streamToOutput(url, output);
    });
</script>

</body>
</html>
