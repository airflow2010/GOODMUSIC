<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>prism | admin</title>
</head>
<body>

<div class="container">
    <div class="page-header">
        <div class="logo-wrap logo-wrap--compact">
            <img class="logo" src="{{ url_for('static', filename='prism_fullsize.png') }}" alt="Logo">
        </div>
        <select onchange="window.location.href=this.value" class="nav-select">
            <option value="{{ url_for('rating_mode') }}">rate</option>
            <option value="{{ url_for('playing_mode') }}">play</option>
            <option value="{{ url_for('admin_mode') }}" selected>admin</option>
        </select>
    </div>
    
    {% if request_submitted %}
    <div class="stat-card stat-card--success">
        âœ… Request submitted. The admin will review it.
    </div>
    {% endif %}
    {% if request_message %}
    <div class="stat-card stat-card--warning">
        {{ request_message }}
    </div>
    {% endif %}

    <h2>General Statistics</h2>
    <div class="stat-card">
        <div class="stat-row">
            <strong>Total Entries:</strong>
            <span>{{ stats.total_entries }}</span>
        </div>
        <div class="stat-row">
            <strong><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="stat-icon"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.42 0-8 2-8 4.5V21h16v-2.5C20 16 16.42 14 12 14z"></path></svg>Rated Entries:</strong>
            <span>{{ stats.rated_count }} ({{ stats.rated_pct }}%)</span>
        </div>
        <div class="stat-row">
            <strong><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="stat-icon"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.42 0-8 2-8 4.5V21h16v-2.5C20 16 16.42 14 12 14z"></path></svg>Favorites:</strong>
            <span>{{ stats.favorite_count }} ({{ stats.favorite_pct }}%)</span>
        </div>
        <div class="stat-row">
            <strong><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" class="stat-icon"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.42 0-8 2-8 4.5V21h16v-2.5C20 16 16.42 14 12 14z"></path></svg>Rejected:</strong>
            <span>{{ stats.rejected_count }} ({{ stats.rejected_pct }}%)</span>
        </div>
    </div>

    <h2>Genre Statistics</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Genre</th>
                <th>Count</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% for genre in stats.genre_stats %}
            <tr>
                <td>{{ genre.name }}</td>
                <td>{{ genre.count }}</td>
                <td>{{ genre.pct }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 class="section-heading">Video Import</h2>
    <div class="stat-card">
        {% if is_admin %}
            {% if import_requests %}
            <h3>Pending Import Requests</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Payload</th>
                        <th>Requested By</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in import_requests %}
                    <tr>
                        <td>{{ req.request_type }}</td>
                        <td class="data-table-cell-wrap">{{ req.payload }}</td>
                        <td>{{ req.requested_by }}</td>
                        <td>{{ req.status }}</td>
                        <td>
                            <form action="{{ url_for('update_import_request', request_id=req.id) }}" method="post" class="admin-btn-row admin-btn-row--tight">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" name="status" value="imported" class="next-button admin-btn button-compact">Mark Imported</button>
                                <button type="submit" name="status" value="rejected" class="next-button admin-btn button-compact button-danger">Reject</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-state">No pending import requests.</p>
            {% endif %}

            {% if import_restricted %}
            <h3>from Substack or YouTube playlists/IDs</h3>
            <div class="admin-callout">
                <strong class="admin-callout-title">Functionality Restricted</strong>
                <p>
                    Importing videos is currently disabled because this instance is running in the cloud and no <code>cookies.txt</code> file was found. 
                    YouTube blocks automated requests from cloud IP addresses.
                </p>
                <p>
                    To enable this feature, please run the application locally or deploy a valid <code>cookies.txt</code> file.
                </p>
            </div>
            {% else %}
            <h3>from Substack</h3>
            <form id="scraper-form" class="admin-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="admin-form-row">
                    <label for="limit_posts" class="admin-form-label admin-form-label--wide">--limit-substack-posts (0 for all)</label>
                    <input type="text" id="limit_posts" name="limit_posts" value="0" class="admin-field admin-field--xs">
                </div>
                <div class="admin-form-row">
                    <label for="limit_entries" class="admin-form-label admin-form-label--wide">--limit-new-db-entries (0 for all)</label>
                    <input type="text" id="limit_entries" name="limit_entries" value="10" class="admin-field admin-field--xs">
                </div>
                <div class="admin-form-row">
                     <label for="substack_url" class="admin-form-label admin-form-label--wide">--substack</label>
                     <input type="text" id="substack_url" name="substack_url" value="https://goodmusic.substack.com/archive" class="admin-field admin-field--half">
                </div>
                <div class="admin-btn-row admin-btn-row--spaced">
                    <button type="submit" class="next-button admin-btn button-accent">Import</button>
                </div>
            </form>

            <pre id="scraper-output" class="admin-output admin-output--tall"></pre>

            <h3 class="section-subheading">from YouTube playlist</h3>
            <form id="playlist-form" class="admin-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="admin-form-row">
                    <label for="playlist_id" class="admin-form-label admin-form-label--wide">Playlist ID (or full URL)</label>
                    <input type="text" id="playlist_id" name="playlist_id" placeholder="PLxxxx" class="admin-field admin-field--half">
                </div>
                <div class="admin-form-row">
                    <label for="playlist_limit" class="admin-form-label admin-form-label--wide">Limit (0 for all)</label>
                    <input type="number" id="playlist_limit" name="playlist_limit" value="0" min="0" class="admin-field admin-field--xs">
                </div>
                <div class="admin-btn-row admin-btn-row--spaced">
                    <button type="submit" class="next-button admin-btn button-accent">Import</button>
                </div>
            </form>
            <pre id="playlist-output" class="admin-output admin-output--medium"></pre>

            <h3 class="section-subheading">from YouTube ID</h3>
            <form id="single-video-form" class="admin-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="admin-form-row">
                    <label for="video_ids" class="admin-form-label admin-form-label--wide">Video IDs (comma or newline separated)</label>
                    <input type="text" id="video_ids" name="video_ids" placeholder="abc123, def456" class="admin-field admin-field--half">
                </div>
                <div class="admin-btn-row admin-btn-row--spaced">
                    <button type="submit" class="next-button admin-btn button-accent">Import</button>
                </div>
            </form>
            <pre id="single-video-output" class="admin-output admin-output--short"></pre>
            {% endif %}
        {% else %}
            <h3>Suggest an Import</h3>
            <p class="helper-text">Requests are reviewed by the admin before importing.</p>
            <form action="{{ url_for('request_import') }}" method="post" class="admin-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="admin-form-row">
                    <label for="request_type" class="admin-form-label admin-form-label--medium">Type</label>
                    <select id="request_type" name="request_type" required class="admin-field admin-field--md">
                        <option value="substack">Substack URL</option>
                        <option value="playlist">YouTube Playlist</option>
                        <option value="video_ids">YouTube Video IDs</option>
                    </select>
                </div>
                <div class="admin-form-row">
                    <label for="payload" class="admin-form-label admin-form-label--medium">Link</label>
                    <input type="text" id="payload" name="payload" required class="admin-field admin-field--wide">
                </div>
                <div class="admin-form-row">
                    <label for="notes" class="admin-form-label admin-form-label--medium">Notes</label>
                    <textarea id="notes" name="notes" placeholder="Optional" rows="1" class="admin-field admin-field--wide"></textarea>
                </div>
                <div class="admin-btn-row admin-btn-row--spaced">
                    <button type="submit" class="next-button admin-btn button-accent">Submit Request</button>
                </div>
            </form>
        {% endif %}
    </div>

    <h2 class="section-heading">Account &amp; Session</h2>
    <div class="stat-card account-session-card">
        {% if user_message and not is_admin %}
        <div class="account-session-message">{{ user_message }}</div>
        {% endif %}
        <div class="account-session-row">
            <div class="account-session-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="36" height="36" fill="currentColor">
                    <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.42 0-8 2-8 4.5V21h16v-2.5C20 16 16.42 14 12 14z"></path>
                </svg>
            </div>
            <div class="account-session-details">
                <div class="account-session-identifier">{{ user_id }}</div>
                <div class="account-session-status">Currently signed in</div>
            </div>
        </div>
        <div class="account-session-divider"></div>
        <div class="admin-btn-row">
            <a href="{{ url_for('logout') }}" class="button-link next-button admin-btn">Log out</a>
            {% if not is_admin %}
            <form action="{{ url_for('delete_own_account') }}" method="post" class="form-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="submit" class="next-button admin-btn button-danger" onclick="return confirm('Delete your account and all ratings?');">Delete Account</button>
            </form>
            {% endif %}
        </div>
    </div>

    {% if is_admin %}
    <h2 class="section-heading">User Management</h2>
    <div class="stat-card">
        {% if user_message %}
        <div class="admin-warning">{{ user_message }}</div>
        {% endif %}
        <form action="{{ url_for('purge_inactive_users') }}" method="post" class="admin-form-row admin-form-row--gap admin-form-row--spaced is-hidden">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <label for="inactive_days" class="admin-form-label admin-form-label--min">Delete users inactive for (days):</label>
            <input type="number" id="inactive_days" name="inactive_days" min="1" value="{{ inactive_days or 30 }}" class="admin-field admin-field--sm">
            <button type="submit" class="next-button admin-btn button-compact button-danger" onclick="return confirm('Delete inactive users and their ratings?');">Delete Inactive</button>
        </form>
        {% if users %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Ratings</th>
                    <th>Last Seen</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr {% if u.inactive %}class="data-table-row-warning"{% endif %}>
                    <td>{{ u.id }}</td>
                    <td>{{ u.role }}</td>
                    <td>{{ u.ratings_count }}</td>
                    <td><span title="{{ u.last_seen_display }}">{{ u.last_seen_date }}</span></td>
                    <td>
                        {% if u.protected %}
                        <span class="text-muted">Protected</span>
                        {% else %}
                        <form action="{{ url_for('delete_user') }}" method="post" class="form-inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <input type="hidden" name="user_id" value="{{ u.id }}">
                            <button type="submit" class="next-button admin-btn button-compact button-danger" onclick="return confirm('Delete user {{ u.id }} and all ratings?');">Delete</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">No users found.</p>
        {% endif %}
    </div>
    {% endif %}

    {% if is_admin %}
    <h2 class="section-heading">Database</h2>
    <div class="stat-card">
        <a class="button-link next-button admin-btn" href="{{ url_for('admin_database') }}">load complete database into table</a>
    </div>
    {% endif %}

    <h2 class="section-heading">Legal</h2>
    <div class="stat-card">
        <div class="login-footer" style="margin-top: 0; justify-content: center;">
            <a href="{{ url_for('tos') }}">TOS</a>
            <span class="footer-divider">&middot;</span>
            <a href="{{ url_for('privacy') }}">Privacy Policy</a>
            <span class="footer-divider">&middot;</span>
            <a href="https://github.com/airflow2010/GOODMUSIC" target="_blank">GitHub Repo</a>
        </div>
    </div>
</div>

<script>
    const csrfToken = "{{ csrf_token }}";

    function streamToOutput(url, outputEl, formData) {
        outputEl.style.display = 'block';
        outputEl.textContent = 'Initializing...\n';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-Token': csrfToken
            }
        })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            outputEl.textContent += '\n--- End of Stream ---';
                            return;
                        }
                        const text = decoder.decode(value);
                        outputEl.textContent += text;
                        outputEl.scrollTop = outputEl.scrollHeight;
                        read();
                    });
                }
                read();
            })
            .catch(err => {
                outputEl.textContent += `\nError: ${err}`;
            });
    }

    const scraperForm = document.getElementById('scraper-form');
    if (scraperForm) {
        scraperForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const output = document.getElementById('scraper-output');
            const formData = new FormData(this);
            streamToOutput("{{ url_for('run_scraper') }}", output, formData);
        });
    }

    const playlistForm = document.getElementById('playlist-form');
    if (playlistForm) {
        playlistForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const output = document.getElementById('playlist-output');
            const formData = new FormData(this);
            streamToOutput("{{ url_for('import_playlist') }}", output, formData);
        });
    }

    const singleVideoForm = document.getElementById('single-video-form');
    if (singleVideoForm) {
        singleVideoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const output = document.getElementById('single-video-output');
            const formData = new FormData(this);
            streamToOutput("{{ url_for('import_video') }}", output, formData);
        });
    }
</script>

</body>
</html>
