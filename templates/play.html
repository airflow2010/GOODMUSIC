<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <title>GOODMUSIC prism | play</title>
    <style>
        .filter-form { display: flex; flex-direction: column; gap: 6px; background-color: #2a2a2a; padding: 12px; border-radius: 4px; margin-bottom: 6px; }
        .filter-row { display: grid; gap: 15px; align-items: center; }
        .filter-row-top { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .filter-row-bottom { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .filter-form .checkbox-group { margin-bottom: 0; }
        .filter-actions { display: flex; justify-content: flex-end; }
        #playing-form { display: flex; flex-direction: column; gap: 8px; }
        #rating-form { display: block; }
        .section-title { margin: 0 0 4px; }
        .filter-form + .section-title { margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="logo-wrap" style="margin-bottom: 0;">
            <img class="logo" src="{{ url_for('static', filename='prism_fullsize.png') }}" alt="Logo">
        </div>
        <select onchange="window.location.href=this.value" class="nav-select">
            <option value="{{ url_for('rating_mode') }}">rate</option>
            <option value="{{ url_for('playing_mode') }}" selected>play</option>
            <option value="{{ url_for('admin_mode') }}">admin</option>
        </select>
    </div>
    <!-- Filter Form -->
    <h2 class="section-title">filter</h2>
    <form id="playing-form" action="{{ url_for('playing_mode') }}" method="post">
        <div class="filter-form">
            <div class="filter-row filter-row-top">
                <div>
                    <label for="genre_filter">genre:</label>
                    <select id="genre_filter" name="genre_filter">
                        <option value="All" {% if filters.genre_filter == 'All' %}selected{% endif %}>All Genres</option>
                        {% for g in genres %}
                            <option value="{{ g }}" {% if g == filters.genre_filter %}selected{% endif %}>{{ g }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="slider-container">
                    <label for="min_rating_music">min_rating_music: <span id="min_rating_music_display">{{ filters.min_rating_music }}</span></label>
                    <input type="range" id="min_rating_music" name="min_rating_music" min="1" max="5" value="{{ filters.min_rating_music }}">
                </div>
                <div class="slider-container">
                    <label for="min_rating_video">min_rating_video: <span id="min_rating_video_display">{{ filters.min_rating_video }}</span></label>
                    <input type="range" id="min_rating_video" name="min_rating_video" min="1" max="5" value="{{ filters.min_rating_video }}">
                </div>
            </div>
            <div class="filter-row filter-row-bottom">
                <div class="checkbox-group">
                    <input type="checkbox" id="favorite_only" name="favorite_only" {% if filters.favorite_only %}checked{% endif %}>
                    <label for="favorite_only">favorite_only</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include_unrated" name="include_unrated" {% if filters.include_unrated %}checked{% endif %}>
                    <label for="include_unrated">include_unrated</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="exclude_rejected" name="exclude_rejected" {% if filters.exclude_rejected %}checked{% endif %}>
                    <label for="exclude_rejected">exclude_rejected</label>
                </div>
                <div class="filter-actions">
                    <button type="submit" class="next-button">Apply</button>
                </div>
            </div>
            <div class="filter-row" style="grid-template-columns: 1fr; gap: 6px;">
                <label for="selected_video_id">resulting playlist ({{ videos_count }} videos)</label>
                <div style="display: flex; gap: 10px; width: 100%;">
                    <select id="selected_video_id" name="selected_video_id" onchange="this.form.submit()" style="flex-grow: 1;">
                        <option value="">-- Random / Shuffle --</option>
                        {% for v in playlist %}
                            <option value="{{ v.video_id }}" {% if video and video.video_id == v.video_id %}selected{% endif %}>
                                {{ v.artist }} - {{ v.track }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" onclick="document.getElementById('selected_video_id').value='';" class="next-button" style="width: auto; white-space: nowrap;">Play Next</button>
                    <button type="button" onclick="toggleExport()" class="next-button" style="background-color: mediumpurple; width: auto;">Export</button>
                </div>
            </div>

            <div id="export-section" style="display: none; background-color: #333; padding: 15px; margin-top: 10px; border-radius: 4px; border: 1px solid #555;">
                <!-- Content loaded via JS -->
                <p>Loading YouTube info...</p>
            </div>
        </div>
    </form>
    {% if index_error %}
        <div class="index-error">
            <div><strong>{{ index_error.summary }}</strong></div>
            {% if index_error.link %}
                <div><a href="{{ index_error.link }}" target="_blank" rel="noopener">Create/view index in console</a></div>
            {% endif %}
            <div class="index-error__raw">{{ index_error.raw }}</div>
        </div>
    {% endif %}

    {% if video %}

        {% if export_message %}
            <div style="background-color: #2a2a2a; border-left: 5px solid #ff9800; padding: 10px; margin-bottom: 20px;">{{ export_message }}</div>
        {% endif %}

        <!-- YouTube Player -->
        <div id="player-error" class="index-error is-hidden">
            <div><strong id="player-error-summary">YouTube player error</strong></div>
            <div class="index-error__raw" id="player-error-raw"></div>
        </div>
        <div class="video-container">
            <div id="player"></div>
        </div>

        <h2 class="section-title">{% if video.date_rated %}change rating of video{% else %}rate video{% endif %}</h2>
        <form id="rating-form" action="{{ url_for('save_play_rating', video_id=video.video_id) }}" method="post">
            <div class="filter-form">
            <!-- Hidden fields to preserve filters -->
            <input type="hidden" name="min_rating_music_hidden" value="{{ filters.min_rating_music }}">
            <input type="hidden" name="min_rating_video_hidden" value="{{ filters.min_rating_video }}">
            <input type="hidden" name="genre_filter_hidden" value="{{ filters.genre_filter }}">
            <input type="hidden" name="favorite_only_hidden" value="{{ 'true' if filters.favorite_only else 'false' }}">
            <input type="hidden" name="include_unrated_hidden" value="{{ 'true' if filters.include_unrated else 'false' }}">
            <input type="hidden" name="exclude_rejected_hidden" value="{{ 'true' if filters.exclude_rejected else 'false' }}">

            <!-- Ratings -->
            <div class="filter-row" style="grid-template-columns: 1fr 1fr;">
                <div>
                    <label for="rating_music">rating_music:</label>
                    <select id="rating_music" name="rating_music" required class="{% if not video.date_rated %}unrated{% endif %}">
                        {% for val, desc in music_ratings.items()|sort(reverse=True) %}
                            <option value="{{ val }}" {% if val == video.rating_music %}selected{% endif %}>{{ desc }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="rating_video">rating_video:</label>
                    <select id="rating_video" name="rating_video" required class="{% if not video.date_rated %}unrated{% endif %}">
                        {% for val, desc in video_ratings.items()|sort(reverse=True) %}
                            <option value="{{ val }}" {% if val == video.rating_video %}selected{% endif %}>{{ desc }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Genre, Booleans, Save Button -->
            <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                <div style="flex-grow: 1;">
                    <input type="text" id="genre" name="genre" value="{{ video.genre }}" list="genre_list" autocomplete="off" placeholder="genre" style="width: 100%;">
                    <datalist id="genre_list">
                        {% for g in genres %}
                            <option value="{{ g }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div class="checkbox-group" style="margin-bottom: 0;">
                    <input type="checkbox" id="favorite" name="favorite" {% if video.favorite %}checked{% endif %}>
                    <label for="favorite">⭐</label>
                </div>
                <div class="checkbox-group" style="margin-bottom: 0;">
                    <input type="checkbox" id="rejected" name="rejected" {% if video.rejected %}checked{% endif %}>
                    <label for="rejected">❌</label>
                </div>
                <button type="submit" class="save-button" style="width: auto; margin: 0; white-space: nowrap;">Save</button>
            </div>
            </div>
        </form>

        <div class="info">
            <p><strong>source:</strong> <a href="{{ video.source }}" target="_blank">{{ video.source }}</a></p>
            <p><strong>video_id:</strong> {{ video.video_id }}</p>
            <p><strong>date_youtube:</strong> {{ video.date_youtube }}</p>
            <p><strong>date_substack:</strong> {{ video.date_substack }}</p>
            <p><strong>date_prism:</strong> {{ video.date_prism or video.created_at }}</p>
            <p><strong>date_rated:</strong> {{ video.date_rated }}</p>
            <p><strong>genre_ai_fidelity:</strong> {{ video.genre_ai_fidelity }}</p>
            <p><strong>genre_ai_remarks:</strong> {{ video.genre_ai_remarks }}</p>
        </div>

    {% else %}
        <h1>No videos match your filter criteria!</h1>
        <p>Try adjusting the filters above.</p>
    {% endif %}
</div>

<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '390',
            width: '640',
            videoId: '{{ video.video_id if video else "" }}',
            playerVars: {
                'playsinline': 1,
                'autoplay': 1
            },
            events: {
                'onError': onPlayerError
            }
        });
    }

    function onPlayerError(event) {
        const playerErrorEl = document.getElementById('player-error');
        const code = event?.data;
        const videoId = '{{ video.video_id if video else "" }}' || 'N/A';
        let errorMessage = 'An unknown error occurred with the YouTube player.';

        switch (code) {
            case 2:
                errorMessage = 'The video request contains an invalid parameter value.';
                break;
            case 5:
                errorMessage = 'The requested content cannot be played in an HTML5 player or another HTML5 player error has occurred.';
                break;
            case 100:
                errorMessage = 'The video requested was not found. This occurs when a video has been removed (for any reason) or has been marked as private.';
                break;
            case 101:
            case 150:
                errorMessage = 'The owner of the requested video does not allow it to be played in embedded players.';
                break;
        }

        console.error('YouTube Player Error', { code: code, videoId: videoId, message: errorMessage, rawEvent: event });
        if (playerErrorEl) {
            playerErrorEl.classList.remove('is-hidden');
            const summaryEl = document.getElementById('player-error-summary');
            const rawEl = document.getElementById('player-error-raw');
            if (summaryEl) {
                summaryEl.textContent = 'YouTube player error';
            }
            if (rawEl) {
                rawEl.textContent = `Code: ${code} | ${errorMessage} | Video ID: ${videoId}`;
            }
        }
    }

    // Script for sliders
    document.addEventListener('DOMContentLoaded', function() {
        // Filter sliders
        const minRatingMusicSlider = document.getElementById('min_rating_music');
        const minRatingMusicDisplay = document.getElementById('min_rating_music_display');
        if (minRatingMusicSlider) {
            minRatingMusicSlider.oninput = function() { minRatingMusicDisplay.textContent = this.value; }
        }

        const minRatingVideoSlider = document.getElementById('min_rating_video');
        const minRatingVideoDisplay = document.getElementById('min_rating_video_display');
        if (minRatingVideoSlider) {
            minRatingVideoSlider.oninput = function() { minRatingVideoDisplay.textContent = this.value; }
        }

        // AJAX for rating form
        const ratingForm = document.getElementById('rating-form');
        if (ratingForm) {
            ratingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const form = this;
                const btn = form.querySelector('.save-button');
                const originalText = btn.textContent;

                btn.textContent = 'Saving...';

                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                }).then(response => {
                    if (response.ok) {
                        btn.textContent = 'Saved';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 1000);
                    }
                });
            });
        }
    });

    function toggleExport() {
        const sec = document.getElementById('export-section');
        if (sec.style.display === 'none') {
            sec.style.display = 'block';
            loadYoutubeInfo();
        } else {
            sec.style.display = 'none';
        }
    }

    function loadYoutubeInfo() {
        fetch('/api/youtube_info')
            .then(response => response.json())
            .then(data => {
                const sec = document.getElementById('export-section');
                if (data.error) {
                    sec.innerHTML = `<p style="color: #ff6b6b;">${data.error}</p>`;
                    return;
                }
                let html = `<h4 style="margin-top:0;">Export to YouTube Playlist</h4>`;
                html += `<p style="font-size:0.9em;">Connected Account: <strong>${data.channel}</strong></p>`;
                html += `<div style="margin-bottom: 10px;">
                            <label>Select Playlist:</label>
                            <select id="export_playlist_id" style="width: 100%;">
                                <option value="">-- Create New Playlist --</option>`;
                data.playlists.forEach(pl => {
                    html += `<option value="${pl.id}">${pl.title}</option>`;
                });
                html += `   </select>
                         </div>`;
                html += `<div style="margin-bottom: 10px;">
                            <label>Or New Playlist Name:</label>
                            <input type="text" id="new_playlist_name" placeholder="My New Playlist">
                         </div>`;
                html += `<p style="font-size: 0.8em; color: #aaa;">Exports all ${ {{ videos_count }} } filtered videos. Duplicates in the target playlist will be skipped.</p>`;
                html += `<button type="button" onclick="submitExport()" class="save-button">Start Export</button>`;
                
                sec.innerHTML = html;
            });
    }

    function submitExport() {
        const mainForm = document.getElementById('playing-form');
        const exportForm = document.createElement('form');
        exportForm.method = 'POST';
        exportForm.action = '{{ url_for("export_playlist") }}';
        
        // Copy main filter inputs
        const inputs = ['min_rating_music', 'min_rating_video', 'genre_filter', 'favorite_only', 'include_unrated', 'exclude_rejected'];
        inputs.forEach(name => {
            const el = mainForm.elements[name];
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = name;
            if (el.type === 'checkbox') {
                if (el.checked) exportForm.appendChild(hidden);
            } else {
                hidden.value = el.value;
                exportForm.appendChild(hidden);
            }
        });
        
        // Add export specific inputs
        const plSelect = document.getElementById('export_playlist_id');
        const newPlInput = document.getElementById('new_playlist_name');
        
        const plHidden = document.createElement('input');
        plHidden.type = 'hidden';
        plHidden.name = 'playlist_id';
        plHidden.value = plSelect.value;
        exportForm.appendChild(plHidden);
        
        const newPlHidden = document.createElement('input');
        newPlHidden.type = 'hidden';
        newPlHidden.name = 'new_playlist_name';
        newPlHidden.value = newPlInput.value;
        exportForm.appendChild(newPlHidden);
        
        document.body.appendChild(exportForm);
        exportForm.submit();
    }
</script>

</body>
</html>
